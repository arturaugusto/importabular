const t=["mousedown","mouseenter","mouseup","mouseleave","touchstart","touchend","touchmove","keydown","paste","cut","copy"];export default class s{constructor({data:t=[],node:s=null,onChange:i=null,minRows:n=1,maxRows:o=1/0,minCols:r=1,maxCols:l=1/0,css:c="",width:a="100%",height:d="80vh"}){if(!s)throw new Error("You need to pass a node argument to Importabular, like this : new Importabular({node: document.body})");this.t=s,this.i={onChange:i,minRows:n,maxRows:o,minCols:r,maxCols:l,css:e+c},this.h={width:a,height:d,border:"none",background:"transparent"},this.o=1,this.l=1,this.u=new h,this.m(),this.p(t),this.g({x:this.i.minCols-1,y:this.i.minRows-1}),this._()}C({x:t,y:s}){return t>=0&&t<this.i.maxCols&&s>=0&&s<this.i.maxRows}_(){const t=Math.ceil(this.iframe.contentWindow.innerHeight/40),s=Math.ceil(this.iframe.contentWindow.innerWidth/100);this.g({x:s-1,y:t-1})}v(){this.i.onChange&&this.i.onChange(this.u.D())}k(t,s,i){const h=document.createElement("div");t.setAttribute("x",s.toString()),t.setAttribute("y",i.toString());const e=this.A(s,i);e?h.textContent=e:h.innerHTML="&nbsp;",t.appendChild(h),this.S({x:s,y:i})}m(){const s=document.createElement("iframe");this.iframe=s,this.t.appendChild(s);const i=s.contentWindow.document;this.cwd=i,i.open(),i.write(`<html lang="${navigator.language}"><body><style>${this.i.css}</style></body></html>`),i.close(),Object.assign(s.style,this.h);const h=document.createElement("table"),e=document.createElement("tbody");h.appendChild(e),i.body.appendChild(h),this.tbody=e,this.table=h;for(let t=0;t<this.l;t++){const s=document.createElement("tr");e.appendChild(s);for(let i=0;i<this.o;i++)this.I(s,i,t)}t.forEach(t=>i.addEventListener(t,this[t],!0))}destroy(){this.T(),t.forEach(t=>this.cwd.removeEventListener(t,this[t],!0)),this.iframe.parentElement.removeChild(this.iframe)}I(t,s,i){const h=document.createElement("td");t.appendChild(h),this.k(h,s,i)}M(){if(!this.C({x:0,y:this.l}))return!1;this.l++;const t=this.l-1,s=document.createElement("tr");this.tbody.appendChild(s);for(let i=0;i<this.o;i++)this.I(s,i,t);return!0}V(){if(!this.C({x:this.o,y:0}))return!1;this.o++;const t=this.o-1;return Array.prototype.forEach.call(this.tbody.children,(s,i)=>{this.I(s,t,i)}),!0}g({x:t,y:s}){for(;t>this.o-1&&this.V(););for(;s>this.l-1&&this.M(););}paste=t=>{if(this.R)return;t.preventDefault();const s=function(t){try{const s=(t.clipboardData||window.clipboardData).getData("text/html"),i=document.createElement("iframe");document.body.appendChild(i),i.contentWindow.document.open(),i.contentWindow.document.write(s),i.contentWindow.document.close();const h=i.contentWindow.document.querySelectorAll("tr"),e=[];if(Array.prototype.forEach.call(h,(t,s)=>{const i=t.querySelectorAll("td");Array.prototype.forEach.call(i,(t,i)=>{const h=t.textContent;e[s]||(e[s]=[]),e[s][i]=h})}),document.body.removeChild(i),e.length)return e}catch(t){}return(t.clipboardData||window.clipboardData).getData("text").split(/\r\n|\n|\r/).map(t=>t.split(""))}(t),{rx:i,ry:h}=this.O,e={x:i[0],y:h[0]};for(let t=0;t<s.length;t++)for(let i=0;i<s[0].length;i++)this.j(e.x+i,e.y+t,s[t][i]);this.L(()=>{this.U=e,this.$={x:e.x+s[0].length-1,y:e.y+s.length-1}}),this.v()};B(){const{rx:t,ry:s}=this.O;if(t[0]===t[1])return null;const i=t[1]-t[0],h=s[1]-s[0],e=[];for(let n=0;n<h;n++){e.push([]);for(let h=0;h<i;h++)e[n].push(this.A(t[0]+h,s[0]+n))}return e}copy=t=>{if(this.R)return;const s=this.B();s&&(t.preventDefault(),t.clipboardData.setData("text/html",function(t){const s=document.createElement("table");return s.setAttribute("lang",navigator.language),t.forEach(t=>{const i=document.createElement("tr");s.appendChild(i),t.forEach(t=>{const s=document.createElement("td");i.appendChild(s),s.textContent=t})}),`<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html lang="${navigator.language}"><head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8"/><title></title></head><body>${s.outerHTML}</body></html>`}(s)),t.clipboardData.setData("text/plain",s.map(t=>t.join("")).join("\n")))};cut=t=>{this.R||(this.copy(t),this.H(""))};keydown=t=>{t.ctrlKey||this.U&&("Escape"===t.key&&this.R&&(t.preventDefault(),this.W(),this.N()),"Enter"===t.key&&(t.preventDefault(),this.P(!1,t.shiftKey?-1:1)),"Tab"===t.key&&(t.preventDefault(),this.P(!0,t.shiftKey?-1:1)),this.R||("Delete"!==t.key&&"Backspace"!==t.key||(t.preventDefault(),this.H("")),"ArrowDown"===t.key&&(t.preventDefault(),this.Y({y:1},t.shiftKey)),"ArrowUp"===t.key&&(t.preventDefault(),this.Y({y:-1},t.shiftKey)),"ArrowLeft"===t.key&&(t.preventDefault(),this.Y({x:-1},t.shiftKey)),"ArrowRight"===t.key&&(t.preventDefault(),this.Y({x:1},t.shiftKey))),1!==t.key.length||this.R||this.L(()=>{const{x:t,y:s}=this.q;this.F({x:t,y:s}),this.G(t,s).firstChild.value=""}))};H(t){this.J(this.O,({x:s,y:i})=>this.j(s,i,t)),this.J(this.O,this.K),this.v()}Y({x:t=0,y:s=0},i){const h=i?this.$:this.U,e={x:h.x+t,y:h.y+s};this.C(e)&&(this.N(),this.g(e),this.L(()=>{i?this.$=e:this.U=this.$=this.q=e}),this.X(e))}P(t,s=1){let{x:h,y:e}=this.q||{x:0,y:0};const n=this.Z(),{rx:o,ry:r}=n>1?this.O:{rx:[0,this.i.maxCols],ry:[0,this.i.maxRows]};let l;if(t)l=i(h,e,s,o[0],o[1]-1,r[0],r[1]-1);else{const t=i(e,h,s,r[0],r[1]-1,o[0],o[1]-1);l={x:t.y,y:t.x}}this.C(l)&&(this.N(),this.g(l),this.L(()=>{this.q=l,n<=1&&(this.U=this.$=l)}),this.X(l))}X({x:t,y:s}){this.G(t,s).scrollIntoView({behavior:"smooth",block:"nearest"})}tt=!1;U=null;$=null;O={rx:[0,0],ry:[0,0]};R=null;q=null;mousedown=t=>{if(!this.mobile){if(3===t.which&&!this.R&&this.Z()){let t=new Range;const{rx:s,ry:i}=this.O;return t.setStart(this.G(s[0],i[0]),0),t.setEnd(this.G(s[0],i[0]),1),this.cwd.getSelection().removeAllRanges(),void this.cwd.getSelection().addRange(t)}this.L(()=>{this.tbody.style.userSelect="none",this.$=this.U=this.q=this.st(t),this.tt=!0})}};mouseenter=t=>{this.mobile||this.tt&&this.L(()=>{this.$=this.st(t)})};it=null;ht=null;et(){this.tt=!1,this.tbody.style.userSelect=""}mouseup=t=>{this.mobile||3!==t.which&&this.tt&&this.L(()=>{this.$=this.st(t),this.et(),this.it&&this.it>Date.now()-300&&this.ht.x===this.$.x&&this.ht.y===this.$.y&&this.F(this.$),this.it=Date.now(),this.ht=this.$})};mouseleave=t=>{t.target===this.tbody&&this.tt&&this.et()};touchstart=t=>{this.R||(this.mobile=!0,this.moved=!1)};touchend=t=>{this.mobile&&(this.R||this.moved||(this.L(()=>{this.$=this.U=this.q=this.st(t)}),this.F(this.q)))};touchmove=t=>{this.mobile&&(this.moved=!0)};F({x:t,y:s}){this.R={x:t,y:s};const i=this.G(t,s),h=i.getBoundingClientRect(),e=i.firstChild.getBoundingClientRect();Object.assign(i.style,{width:h.width-2,height:h.height}),i.removeChild(i.firstChild);const n=document.createElement("input");n.type="text",n.value=this.A(t,s),Object.assign(n.style,{width:e.width,height:e.height}),i.appendChild(n),n.focus(),n.addEventListener("blur",this.N),n.addEventListener("keydown",this.nt)}T(){if(this.R){const{x:t,y:s}=this.R,i=this.G(t,s).firstChild;i.removeEventListener("blur",this.N),i.removeEventListener("keydown",this.nt)}}W(){if(!this.R)return;const{x:t,y:s}=this.R;this.G(t,s).firstChild.value=this.A(t,s)}N=()=>{if(!this.R)return;const{x:t,y:s}=this.R,i=this.G(t,s);i.style.width="",i.style.height="";const h=i.firstChild;h.removeEventListener("blur",this.N),h.removeEventListener("keydown",this.nt),this.j(t,s,h.value),i.removeChild(h),this.R=null,this.k(i,t,s),this.v()};nt=t=>{13===t.keyCode&&(this.N(),t.preventDefault())};L(t){const s=this.O;t(),this.O=this.ot(),this.J(s,this.S),this.J(this.O,this.S)}ot(){if(!this.U)return{rx:[0,0],ry:[0,0]};let t=[this.U.x,this.$.x];t[0]>t[1]&&t.reverse();let s=[this.U.y,this.$.y];return s[0]>s[1]&&s.reverse(),{rx:[t[0],t[1]+1],ry:[s[0],s[1]+1]}}J({rx:t,ry:s},i){for(let h=t[0];h<t[1];h++)for(let t=s[0];t<s[1];t++)this.C({x:h,y:t})&&i({x:h,y:t})}S=({x:t,y:s})=>{this.G(t,s).className=this.rt(t,s)};Z(){const{rx:t,ry:s}=this.O;return(t[1]-t[0])*(s[1]-s[0])}rt(t,s){const{rx:i,ry:h}=this.O;let e="";return t>=i[0]&&t<i[1]&&s>=h[0]&&s<h[1]&&(e+=" selected",this.Z()>1&&(e+=" multi")),this.q&&this.q.x===t&&this.q.y===s&&(e+=" focus"),this.R&&t===this.R.x&&s===this.R.y&&(e+=" editing"),e}K=({x:t,y:s})=>{const i=this.G(t,s).firstChild;"DIV"===i.tagName&&(i.textContent=this.A(t,s)),this.S({x:t,y:s})};st(t){let s=t.target;for(;!s.getAttribute("x")&&s.parentElement;)s=s.parentElement;return{x:parseInt(s.getAttribute("x"))||0,y:parseInt(s.getAttribute("y"))||0}}setData(t){this.u.lt(),this.p(t);for(let t=0;t<this.o;t++)for(let s=0;s<this.l;s++)this.K({x:t,y:s})}getData(){return this.u.D()}p(t){t.forEach((t,s)=>{t.forEach((t,i)=>{this.j(i,s,t)})})}j(t,s,i){this.C({x:t,y:s})&&(this.u.j(t,s,i),this.g({x:t+1,y:s+1}),this.K({x:t,y:s}))}A(t,s){return this.u.A(t,s)}G(t,s){return this.tbody.children[s].children[t]}}function i(t,s,i,h,e,n,o){if((t+=i)<h){if(e===1/0)return{x:h,y:s};if(t=e,--s<n){if(o===1/0)return{x:h,y:n};s=o}}return t>e&&(t=h,++s>o&&(s=n,t=h)),{x:t,y:s}}class h{u={};j(t,s,i){const h=this.u,e=function(t){return 0===t?"0":t?t.toString():""}(i);var n;e?(h[t]||(h[t]={}),h[t][s]=e):h[t]&&h[t][s]&&(delete h[t][s],n=h[t],0===Object.keys(n).length&&delete h[t])}lt(){this.u={}}A(t,s){const i=this.u;return i&&i[t]&&i[t][s]||""}D(){let t=1,s=1;for(let i in this.u)for(let h in this.u[i])s=Math.max(s,parseInt(h)+1),t=Math.max(t,parseInt(i)+1);const i=[];for(let h=0;h<s;h++){i.push([]);for(let s=0;s<t;s++)i[h].push(this.A(s,h))}return i}}const e="\nhtml{\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n::-webkit-scrollbar {\n  visibility: hidden;\n}\n*{\n  box-sizing: border-box;\n}\nbody{\n  padding: 0; \n  margin: 0;\n}\ntable{\n  border-spacing: 0;\n  background: white;\n  border: 1px solid #ddd;\n  border-width: 0 1px 1px 0;\n  font-size: 16px;\n  font-family: sans-serif;\n  border-collapse: separate;\n}\ntd{\n  padding:0;\n  border: 1px solid;\n  border-color: #ddd transparent transparent #ddd; \n}\ntd.selected.multi:not(.editing){\n  background:#d7f2f9;\n} \ntd.focus:not(.editing){\n  border-color: black;\n} \ntd>*{\n  border:none;\n  padding:10px;\n  min-width:100px;\n  min-height: 40px;\n  font:inherit;\n  line-height: 20px;\n  color:inherit;\n  white-space: normal;\n}\ntd>div::selection {\n    color: none;\n    background: none;\n}\n";